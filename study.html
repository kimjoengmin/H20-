<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>스터디 모집 - Handong Connect</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
    <style>
      /* 이 페이지를 위한 특정 스타일 (기존 style.css에 추가해도 좋음) */

      /* Study Recruitment Page Specific Styles */
      .study-recruitment-section {
        padding: 60px 0;
      }

      .study-recruitment-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 25px;
      }

      .study-header {
        text-align: center;
        margin-bottom: 50px;
      }

      .study-header h1 {
        font-size: 3em;
        color: var(--primary-purple);
        margin-bottom: 15px;
        font-weight: 700;
      }

      .study-header p {
        font-size: 1.15em;
        color: var(--text-medium);
        margin-bottom: 30px;
      }

      .search-and-create {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 20px;
        margin-bottom: 40px;
      }

      .search-bar {
        flex-grow: 1;
        display: flex;
        position: relative;
      }

      .search-bar input {
        width: 100%;
        padding: 15px 20px;
        border: 1px solid var(--border-light);
        border-radius: var(--border-radius-base);
        font-size: 1.1em;
        padding-right: 50px; /* 아이콘 공간 확보 */
      }

      .search-bar i {
        position: absolute;
        right: 20px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-light);
        font-size: 1.2em;
      }

      .btn-create-study {
        background-color: var(--primary-blue);
        color: var(--bg-white);
        padding: 15px 25px;
        border-radius: var(--border-radius-base);
        font-weight: 600;
        font-size: 1.05em;
        transition: background-color 0.3s ease, transform 0.2s ease;
        white-space: nowrap; /* 버튼 텍스트가 줄바꿈되지 않도록 */
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-create-study:hover {
        background-color: #0056b3;
        transform: translateY(-2px);
      }

      .category-filters {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 50px;
      }

      .filter-btn {
        background-color: var(--bg-white);
        border: 1px solid var(--border-light);
        color: var(--text-medium);
        padding: 12px 20px;
        border-radius: 25px;
        font-size: 0.95em;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .filter-btn:hover {
        background-color: var(--primary-purple);
        color: var(--bg-white);
        border-color: var(--primary-purple);
      }

      .filter-btn.active {
        background-color: var(--primary-purple);
        color: var(--bg-white);
        border-color: var(--primary-purple);
        box-shadow: var(--shadow-light);
      }

      .study-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
      }

      .study-card {
        background-color: var(--bg-white);
        padding: 30px;
        border-radius: var(--border-radius-base);
        box-shadow: var(--shadow-medium);
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* 내용과 푸터 간격 */
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .study-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
      }

      .study-card h3 {
        font-size: 1.8em;
        color: var(--primary-purple);
        margin-bottom: 15px;
        font-weight: 700;
      }

      .study-card .study-meta {
        font-size: 0.95em;
        color: var(--text-light);
        margin-bottom: 15px;
      }

      .study-card .study-description {
        font-size: 1.05em;
        color: var(--text-dark);
        line-height: 1.6;
        margin-bottom: 20px;
        flex-grow: 1; /* 설명 부분이 최대한 공간을 차지하도록 */
      }

      .study-card .study-tags {
        margin-top: 15px;
        margin-bottom: 15px;
      }

      .study-card .tag {
        display: inline-block;
        background-color: var(--bg-light);
        color: var(--text-medium);
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        margin-right: 8px;
        margin-bottom: 8px;
      }

      .study-card .status {
        display: inline-block;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9em;
        margin-bottom: 15px; /* 상태 아래 여백 */
      }

      .status.recruiting {
        background-color: #e8f5e9; /* Light green */
        color: var(--secondary-green); /* Green */
      }

      .status.closed {
        background-color: #ffe0b2; /* Light orange */
        color: #fb8c00; /* Orange */
      }

      .status.full {
        background-color: #ffcdd2; /* Light red */
        color: #e53935; /* Red */
      }

      .study-card .btn-view-details {
        display: block;
        width: 100%;
        padding: 12px 20px;
        background-color: var(--primary-blue);
        color: var(--bg-white);
        border-radius: var(--border-radius-sm);
        text-align: center;
        font-weight: 600;
        transition: background-color 0.3s ease;
      }

      .study-card .btn-view-details:hover {
        background-color: #0056b3;
      }

      /* Responsive Design for Study Recruitment Page */
      @media (max-width: 768px) {
        .study-header h1 {
          font-size: 2.5em;
        }
        .study-header p {
          font-size: 1em;
        }
        .search-and-create {
          flex-direction: column;
          align-items: stretch;
        }
        .btn-create-study {
          width: 100%;
          text-align: center;
          justify-content: center; /* 아이콘과 텍스트 중앙 정렬 */
        }
        .filter-btn {
          padding: 10px 15px;
          font-size: 0.9em;
        }
        .study-grid {
          grid-template-columns: 1fr; /* 모바일에서 한 줄에 하나씩 */
        }
        .study-card {
          padding: 25px;
        }
        .study-card h3 {
          font-size: 1.5em;
        }
      }

      @media (max-width: 480px) {
        .study-header h1 {
          font-size: 2em;
        }
        .study-header p {
          font-size: 0.9em;
        }
        .search-bar input {
          padding: 12px 15px;
          font-size: 0.9em;
        }
        .btn-create-study {
          padding: 12px 20px;
          font-size: 0.95em;
        }
        .filter-btn {
          font-size: 0.85em;
          padding: 8px 12px;
        }
      }

      .no-studies-message {
        /* 추가된 CSS - 스터디 없을 때 메시지 */
        text-align: center;
        color: var(--text-medium);
        font-size: 1.1em;
        padding: 50px;
        background: var(--bg-white);
        border: 1px solid var(--border-light);
        border-radius: var(--border-radius-base);
        grid-column: 1 / -1; /* 그리드 전체 너비 차지 */
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-container">
        <a href="index.html" class="logo">
          <img src="./images/logo.png" alt="HANDONG CONNECT 로고" />
        </a>
        <ul class="nav-links">
          <li><a href="index.html#sections">둘러보기</a></li>
          <li><a href="majors_all.html">학부/전공</a></li>
          <li><a href="institute.html">동아리/학회</a></li>
          <li><a href="community.html" class="active">커뮤니티</a></li>
          <li><a href="inquiry.html">문의</a></li>
        </ul>
        <div class="user-actions">
          <a href="login,membership.html" class="btn-login"
            ><i class="fas fa-user-circle"></i> My 계정</a
          >
        </div>
      </div>
    </nav>

    <main class="main-content study-recruitment-section">
      <div class="study-recruitment-container">
        <div class="study-header">
          <h1>스터디 모집</h1>
          <p>함께 성장할 스터디 팀원을 찾아보세요!</p>
          <div class="search-and-create">
            <div class="search-bar">
              <input
                type="text"
                placeholder="스터디 검색..."
                id="studySearchInput"
              />
              <i class="fas fa-search"></i>
            </div>
            <a href="makestudy.html" class="btn-create-study">
              <i class="fas fa-plus"></i> 새 스터디 모집
            </a>
          </div>
        </div>

        <div class="category-filters">
          <button class="filter-btn active" data-category="all">전체</button>
          <button class="filter-btn" data-category="major">전공 스터디</button>
          <button class="filter-btn" data-category="language">
            어학 스터디
          </button>
          <button class="filter-btn" data-category="job">취업 스터디</button>
          <button class="filter-btn" data-category="certificate">
            자격증 스터디
          </button>
          <button class="filter-btn" data-category="etc">기타</button>
        </div>

        <div class="study-grid" id="studyGrid">
          <div
            class="no-studies-message"
            id="noStudiesMessage"
            style="display: none"
          >
            현재 모집 중인 스터디가 없습니다. 새로운 스터디를 등록해보세요!
          </div>
        </div>
      </div>
    </main>

    <footer class="main-footer">
      <p>&copy; 2025 Handong Connect. All rights reserved.</p>
    </footer>

    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        query,
        orderBy,
        onSnapshot,
        where,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      // Firebase 설정 - 여기에 본인의 Firebase 프로젝트 설정을 입력하세요
      const firebaseConfig = {
        apiKey: "AIzaSyCIdDH-9l80GCu_PRz7LPyQmKvcIL6nPyg",
        authDomain: "team-h20.firebaseapp.com",
        projectId: "team-h20",
        storageBucket: "team-h20.firebasestorage.app",
        messagingSenderId: "845558888214",
        appId: "1:845558888214:web:73959e7ab377fd03620237",
        measurementId: "G-KZ1MQMH2EK",
      };

      // Firebase 앱 초기화
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      // 'studies' 컬렉션 참조
      const studyCollectionRef = collection(db, "studies");

      // DOM 요소 가져오기
      const studyGridContainer = document.getElementById("studyGrid");
      const noStudiesMessage = document.getElementById("noStudiesMessage");
      const categoryButtons = document.querySelectorAll(".filter-btn");
      const studySearchInput = document.getElementById("studySearchInput");

      // 현재 필터링 및 검색 상태를 저장할 변수
      let currentCategory = "all"; // 기본값은 '전체'
      let currentSearchTerm = ""; // 기본값은 빈 문자열

      // 스터디 카테고리 한글 라벨 (Firebase에 저장된 영문 카테고리를 한글로 표시하기 위함)
      const categoryLabels = {
        major: "전공 스터디",
        language: "어학 스터디",
        job: "취업 스터디",
        certificate: "자격증 스터디",
        etc: "기타",
        all: "전체", // '전체'는 실제 Firestore 필터링에는 사용되지 않지만, 라벨 표시를 위해 포함
      };

      // 스터디 목록을 실시간으로 가져와서 표시하는 함수
      function loadStudies() {
        // 기본 쿼리: 생성 시간 역순으로 정렬
        let q = query(studyCollectionRef, orderBy("createdAt", "desc"));

        // 카테고리 필터링 적용
        if (currentCategory !== "all") {
          q = query(q, where("category", "==", currentCategory));
        }

        // onSnapshot을 사용하여 실시간으로 데이터 변경 감지
        onSnapshot(q, (snapshot) => {
          studyGridContainer.innerHTML = ""; // 기존 목록 비우기
          let hasResults = false; // 검색/필터링 결과가 있는지 여부

          // 스냅샷이 비어있으면 "스터디 없음" 메시지 표시
          if (snapshot.empty && currentSearchTerm === "") {
            noStudiesMessage.style.display = "block";
            return;
          }

          snapshot.forEach((doc) => {
            const study = doc.data();
            const studyId = doc.id; // 문서 ID도 필요할 수 있으니 가져옴

            // 검색어 필터링 (Firestore 쿼리 대신 클라이언트 측에서 처리)
            const matchesSearch =
              !currentSearchTerm || // 검색어가 없으면 항상 true
              study.title
                .toLowerCase()
                .includes(currentSearchTerm.toLowerCase()) ||
              study.description
                .toLowerCase()
                .includes(currentSearchTerm.toLowerCase()) ||
              (study.schedule &&
                study.schedule
                  .toLowerCase()
                  .includes(currentSearchTerm.toLowerCase())); // 일정에도 검색 적용

            if (matchesSearch) {
              hasResults = true; // 결과가 있음을 표시
              const studyCard = document.createElement("div");
              studyCard.classList.add("study-card");

              // 스터디 상태 결정 (capacity가 0보다 크면 '모집 중', 아니면 '모집 완료' 또는 '모집 마감' 등)
              // 실제 모집 인원이 차는 로직이 없으므로, 현재는 capacity만으로 판단.
              const statusClass = study.capacity > 0 ? "recruiting" : "full"; // full 클래스 대신 closed도 가능
              const statusText = study.capacity > 0 ? "모집 중" : "모집 마감";

              studyCard.innerHTML = `
                <h3>${study.title}</h3>
                <div class="study-meta">
                  <span>모집: ${study.capacity}명</span>
                  <span>기간: ${study.schedule || "미정"}</span>
                </div>
                <p class="study-description">${study.description}</p>
                <div class="study-tags">
                  <span class="tag">${
                    categoryLabels[study.category] || "기타"
                  }</span>
                </div>
                <span class="status ${statusClass}">${statusText}</span>
                <a href="#" class="btn-view-details" data-id="${studyId}">상세 보기</a>
              `;
              studyGridContainer.appendChild(studyCard);
            }
          });

          // 검색/필터링 결과가 없으면 메시지 표시
          if (!hasResults) {
            noStudiesMessage.style.display = "block";
          } else {
            noStudiesMessage.style.display = "none";
          }
        });
      }

      // 카테고리 버튼 클릭 이벤트 리스너 설정
      categoryButtons.forEach((button) => {
        button.addEventListener("click", () => {
          // 모든 버튼의 'active' 클래스 제거
          categoryButtons.forEach((btn) => btn.classList.remove("active"));
          // 클릭된 버튼에 'active' 클래스 추가
          button.classList.add("active");
          // 현재 카테고리 업데이트
          currentCategory = button.dataset.category;
          // 스터디 목록 다시 로드
          loadStudies();
        });
      });

      // 검색 입력 필드 변경 이벤트 (디바운싱 적용)
      let searchTimeout;
      studySearchInput.addEventListener("input", () => {
        clearTimeout(searchTimeout); // 이전 타이머 클리어
        searchTimeout = setTimeout(() => {
          currentSearchTerm = studySearchInput.value.trim(); // 현재 검색어 업데이트
          loadStudies(); // 스터디 목록 다시 로드
        }, 300); // 300ms 후에 검색 실행
      });

      // 페이지 로드 시 스터디 목록 로드 함수 호출
      document.addEventListener("DOMContentLoaded", loadStudies);
    </script>
    <script type="module" src="firebase-config.js"></script>

    <script type="module">
      import { auth } from "./firebase-config.js"; // 설정 파일에서 auth 객체를 가져옵니다.
      import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

      onAuthStateChanged(auth, (user) => {
        if (!user) {
          // 사용자가 로그인하지 않은 경우
          alert("이 페이지는 로그인이 필요합니다. 로그인 페이지로 이동합니다.");
          window.location.href = "login,membership.html"; // 로그인/회원가입 선택 페이지로 리디렉션
        }
        // 사용자가 로그인한 경우에는 아무 작업도 하지 않고 페이지 로드를 계속합니다.
      });
    </script>
    <script src="script.js"></script>
    <script type="module">
      import { auth } from "./firebase-config.js";
      import {
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

      const myAccountBtn = document.querySelector(".user-actions .btn-login");

      if (myAccountBtn) {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            myAccountBtn.innerHTML =
              '<i class="fas fa-sign-out-alt"></i> 로그아웃';
            myAccountBtn.href = "#";
            myAccountBtn.onclick = (e) => {
              e.preventDefault();
              if (confirm("정말 로그아웃 하시겠습니까?")) {
                signOut(auth).then(() => {
                  alert("로그아웃되었습니다.");
                  window.location.href = "index.html";
                });
              }
            };
          } else {
            myAccountBtn.innerHTML =
              '<i class="fas fa-user-circle"></i> My 계정';
            myAccountBtn.href = "login,membership.html";
            myAccountBtn.onclick = null;
          }
        });
      }
    </script>
  </body>
</html>
