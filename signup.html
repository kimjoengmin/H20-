<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>íšŒì›ê°€ì… â€“ Handong Connect</title>
    <link
      href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.6/dist/web/static/pretendard.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --primary: #5b6dff;
        --bg: #f5f7ff;
        --border: #e0e3ff;
        --radius: 12px;
        --shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      }

      body {
        margin: 0;
        font-family: "Pretendard", sans-serif;
        background: linear-gradient(135deg, #4a6cf7, #76b4f9, #ffe36e);
        background-size: 150% 150%;
        background-repeat: no-repeat;
        background-attachment: fixed;
        color: #2d2d2d;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
      }

      .container {
        display: flex;
        max-width: 1200px;
        margin: 40px auto;
        gap: 32px;
        padding: 0 16px;
      }

      .card {
        flex: 1 1 0;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        padding: 32px 40px;
        min-width: 400px;
      }

      .card h1 {
        margin-top: 0;
        font-size: 1.6rem;
        color: var(--primary);
        text-align: center;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
      }

      .form-group label {
        margin-bottom: 6px;
        font-weight: 600;
      }

      .form-group input,
      .form-group select {
        padding: 10px 14px;
        border: 1px solid #cbd0ff;
        border-radius: 8px;
        font-size: 1rem;
      }

      .form-row {
        display: flex;
        gap: 20px;
      }

      .form-row > .form-group {
        flex: 1 1 0;
      }

      .button-row {
        display: flex;
        justify-content: flex-end;
        gap: 12px;
        margin-top: 32px;
      }

      button {
        padding: 10px 24px;
        font-size: 0.95rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background 0.2s ease;
      }

      .btn-save {
        background: var(--primary);
        color: #fff;
      }

      .btn-save:hover {
        background: #4556e8;
      }

      .btn-edit {
        background: #f0f1ff;
        color: #3b3b3b;
        border: 1px solid var(--border);
      }

      .btn-edit:hover {
        background: #e4e6ff;
      }

      #errorMessage,
      #passwordMatchMessage {
        margin-top: 10px;
        text-align: center;
        font-weight: 500;
      }
      #errorMessage {
        color: red;
      }
      #passwordMatchMessage {
        font-size: 0.9em;
      }

      /* íšŒì›ê°€ì… ì™„ë£Œ í™”ë©´ ìŠ¤íƒ€ì¼ì€ ì´ì œ ì‚¬ìš©ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì œê±°í•˜ê±°ë‚˜ display: noneìœ¼ë¡œ ìœ ì§€í•©ë‹ˆë‹¤. */
      #signup-success-section {
        display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
        /* ì´ ì„¹ì…˜ì€ ì´ì œ JavaScriptì—ì„œ ì§ì ‘ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. */
      }
    </style>
  </head>

  <body>
    <div class="container">
      <section class="card" id="account-form">
        <a
          href="login,membership.html"
          style="
            text-decoration: none;
            color: #4a6cf7;
            font-weight: 600;
            font-size: 0.95rem;
            display: inline-block;
            margin-bottom: 12px;
          "
        >
          â† ë¡œê·¸ì¸/íšŒì›ê°€ì… í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°
        </a>
        <h1>íšŒì›ê°€ì…</h1>
        <form onsubmit="saveAccount(event)">
          <div class="form-row">
            <div class="form-group">
              <label for="name">ì´ë¦„</label>
              <input
                id="name"
                type="text"
                placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: í™ê¸¸ë™)"
                required
              />
            </div>
            <div class="form-group">
              <label for="studentId">í•™ë²ˆ</label>
              <input
                id="studentId"
                type="text"
                placeholder="í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 20240001)"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label for="department">í•™ë¶€</label>
            <select id="department" onchange="toggleMajorFields()" required>
              <option value="">í•™ë¶€ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
              <option value="ê¸€ë¡œë²Œë¦¬ë”ì‹­í•™ë¶€">ê¸€ë¡œë²Œë¦¬ë”ì‹­í•™ë¶€</option>
              <option value="ê²½ì˜ê²½ì œí•™ë¶€">ê²½ì˜ê²½ì œí•™ë¶€</option>
              <option value="ICTì°½ì—…í•™ë¶€">ICTì°½ì—…í•™ë¶€</option>
              <option value="êµ­ì œì–´ë¬¸í•™ë¶€">êµ­ì œì–´ë¬¸í•™ë¶€</option>
              <option value="ì „ì‚°ì „ìê³µí•™ë¶€">ì „ì‚°ì „ìê³µí•™ë¶€</option>
              <option value="ë²•í•™ë¶€">ë²•í•™ë¶€</option>
              <option value="ìƒëª…ê³¼í•™ë¶€">ìƒëª…ê³¼í•™ë¶€</option>
              <option value="ê³µê°„í™˜ê²½ì‹œìŠ¤í…œê³µí•™ë¶€">ê³µê°„í™˜ê²½ì‹œìŠ¤í…œê³µí•™ë¶€</option>
              <option value="ì»¤ë®¤ë‹ˆì¼€ì´ì…˜í•™ë¶€">ì»¤ë®¤ë‹ˆì¼€ì´ì…˜í•™ë¶€</option>
              <option value="ê¸°ê³„ì œì–´ê³µí•™ë¶€">ê¸°ê³„ì œì–´ê³µí•™ë¶€</option>
              <option value="ì½˜í…ì¸ ìœµí•©ë””ìì¸í•™ë¶€">ì½˜í…ì¸ ìœµí•©ë””ìì¸í•™ë¶€</option>
              <option value="ìƒë‹´ì‹¬ë¦¬ì‚¬íšŒë³µì§€í•™ë¶€">ìƒë‹´ì‹¬ë¦¬ì‚¬íšŒë³µì§€í•™ë¶€</option>
              <option value="ì°½ì˜ìœµí•©êµìœ¡ì›">ì°½ì˜ìœµí•©êµìœ¡ì›</option>
              <option value="AIìœµí•©êµìœ¡ì›">AIìœµí•©êµìœ¡ì›</option>
            </select>
          </div>

          <div class="form-row" id="major-row">
            <div class="form-group">
              <label for="major1">ì œ1ì „ê³µ</label>
              <input
                id="major1"
                type="text"
                placeholder="ì œ1ì „ê³µì„ ì…ë ¥í•˜ì„¸ìš”"
              />
            </div>
            <div class="form-group">
              <label for="major2">ì œ2ì „ê³µ</label>
              <input
                id="major2"
                type="text"
                placeholder="ì œ2ì „ê³µì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ ì‚¬í•­)"
              />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
              <input
                id="password"
                type="password"
                placeholder="6ì ì´ìƒì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                required
                onkeyup="checkPasswordMatch()"
              />
            </div>
            <div class="form-group">
              <label for="confirmPassword">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
              <input
                id="confirmPassword"
                type="password"
                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”"
                required
                onkeyup="checkPasswordMatch()"
              />
            </div>
          </div>
          <p id="passwordMatchMessage"></p>
          <div class="form-group">
            <label for="email">ì´ë©”ì¼</label>
            <input
              id="email"
              type="email"
              placeholder="í•œë™ëŒ€í•™êµ ì´ë©”ì¼(@handong.ac.kr)ì„ ì…ë ¥í•˜ì„¸ìš”"
              required
            />
          </div>

          <div class="form-group">
            <label for="phone">ì „í™”ë²ˆí˜¸</label>
            <input
              id="phone"
              type="tel"
              placeholder="ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 010-1234-5678)"
              required
            />
          </div>

          <p id="errorMessage"></p>
          <div class="button-row">
            <button type="button" class="btn-edit" onclick="resetForm()">
              ì´ˆê¸°í™”
            </button>
            <button type="submit" class="btn-save">ì €ì¥</button>
          </div>
        </form>
      </section>

      <section class="card" id="signup-success-section" style="display: none">
        <h2>ğŸ‰ íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
        <p>ì´ì œ ë¡œê·¸ì¸í•˜ì—¬ Handong Connectë¥¼ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        <a href="login.html" class="btn-login">ë¡œê·¸ì¸ í•˜ëŸ¬ ê°€ê¸°</a>
      </section>
    </div>

    <script type="module">
      // Firebase ê´€ë ¨ ëª¨ë“ˆë“¤ì„ ê°€ì ¸ì˜µë‹ˆë‹¤.
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
      // getAnalyticsëŠ” ì‚¬ìš©ì ë¶„ì„ì„ ìœ„í•œ ê²ƒì´ë¯€ë¡œ, í•„ìš” ì—†ìœ¼ë©´ ì´ ì¤„ì€ ì‚­ì œí•´ë„ ë©ë‹ˆë‹¤.
      // import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";

      // Firebase ì½˜ì†”ì—ì„œ ë³µì‚¬í•œ firebaseConfig ê°ì²´ ë‚´ìš©ì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
      // ìŠ¤í¬ë¦°ìƒ· `image_365c5d.jpg`ì˜ ì‹¤ì œ ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
      const firebaseConfig = {
        apiKey: "AIzaSyCIdDH-9l80GCu_PRz7LPyQmKvcIL6nPyg",
        authDomain: "team-h20.firebaseapp.com",
        projectId: "team-h20",
        storageBucket: "team-h20.firebasestorage.app",
        messagingSenderId: "845558888214",
        appId: "1:845558888214:web:73959e7ab377fd03620237",
        measurementId: "G-KZ1MQMH2EK",
      };

      // Firebase ì•± ì´ˆê¸°í™”
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app); // ì¸ì¦ ì„œë¹„ìŠ¤ ê°€ì ¸ì˜¤ê¸°
      const db = getFirestore(app); // Firestore ë°ì´í„°ë² ì´ìŠ¤ ì„œë¹„ìŠ¤ ê°€ì ¸ì˜¤ê¸°

      // analyticsë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ì•„ë˜ ì¤„ì€ ì‚­ì œí•´ë„ ë©ë‹ˆë‹¤.
      // const analytics = getAnalytics(app);

      // í•™ë¶€ì— ë”°ë¼ ì „ê³µ í•„ë“œ í™œì„±í™”/ë¹„í™œì„±í™”
      function toggleMajorFields() {
        const dept = document.getElementById("department").value;
        const majorsDisabled = dept === "ê¸€ë¡œë²Œë¦¬ë”ì‹­í•™ë¶€";
        ["major1", "major2"].forEach((id) => {
          const field = document.getElementById(id);
          field.disabled = majorsDisabled;
          field.value = majorsDisabled ? "" : field.value;
          field.placeholder = majorsDisabled
            ? "ê¸€ë¡œë²Œë¦¬ë”ì‹­í•™ë¶€ëŠ” ì „ê³µ ì…ë ¥ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤."
            : id === "major1"
            ? "ì œ1ì „ê³µì„ ì…ë ¥í•˜ì„¸ìš”"
            : "ì œ2ì „ê³µì„ ì…ë ¥í•˜ì„¸ìš” (ì„ íƒ ì‚¬í•­)";
          field.required = !majorsDisabled && id === "major1"; // ì œ1ì „ê³µì€ í•„ìˆ˜, ì œ2ì „ê³µì€ ì„ íƒ
        });
      }

      // ë¹„ë°€ë²ˆí˜¸ ì¼ì¹˜ ì—¬ë¶€ ì‹¤ì‹œê°„ í™•ì¸
      function checkPasswordMatch() {
        const password = document.getElementById("password").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;
        const messageDisplay = document.getElementById("passwordMatchMessage");

        if (password.length === 0 && confirmPassword.length === 0) {
          messageDisplay.textContent = "";
          messageDisplay.style.color = "";
          return;
        }

        if (password === confirmPassword) {
          messageDisplay.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.";
          messageDisplay.style.color = "green";
        } else {
          messageDisplay.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
          messageDisplay.style.color = "red";
        }
      }

      // í¼ í•„ë“œ ì´ˆê¸°í™” í•¨ìˆ˜
      function resetForm() {
        document.getElementById("name").value = "";
        document.getElementById("studentId").value = "";
        document.getElementById("department").value = "";
        document.getElementById("major1").value = "";
        document.getElementById("major2").value = "";
        document.getElementById("password").value = "";
        document.getElementById("confirmPassword").value = "";
        document.getElementById("email").value = "";
        document.getElementById("phone").value = "";
        document.getElementById("errorMessage").textContent = "";
        document.getElementById("passwordMatchMessage").textContent = "";
        toggleMajorFields(); // ì´ˆê¸°í™” í›„ ì „ê³µ í•„ë“œ ìƒíƒœ ë‹¤ì‹œ ì„¤ì •
      }

      // íšŒì›ê°€ì… ë¡œì§ (Firebase ì—°ë™)
      async function saveAccount(event) {
        event.preventDefault();

        const name = document.getElementById("name").value.trim();
        const studentId = document.getElementById("studentId").value.trim();
        const department = document.getElementById("department").value.trim();
        const major1 = document.getElementById("major1").value.trim();
        const major2 = document.getElementById("major2").value.trim();
        const password = document.getElementById("password").value;
        const confirmPassword =
          document.getElementById("confirmPassword").value;
        const email = document.getElementById("email").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const errorMessageDisplay = document.getElementById("errorMessage");
        const passwordMatchMessageDisplay = document.getElementById(
          "passwordMatchMessage"
        );

        errorMessageDisplay.textContent = "";
        passwordMatchMessageDisplay.textContent = "";

        // 1. í´ë¼ì´ì–¸íŠ¸ ì¸¡ ìœ íš¨ì„± ê²€ì‚¬
        if (
          !name ||
          !studentId ||
          !department ||
          !password ||
          !confirmPassword ||
          !email ||
          !phone
        ) {
          errorMessageDisplay.textContent = "ëª¨ë“  í•„ìˆ˜ ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
          return;
        }

        if (department !== "ê¸€ë¡œë²Œë¦¬ë”ì‹­í•™ë¶€" && !major1) {
          errorMessageDisplay.textContent = "ì œ1ì „ê³µì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
          return;
        }

        if (password.length < 6) {
          errorMessageDisplay.textContent = "ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
          return;
        }

        if (password !== confirmPassword) {
          errorMessageDisplay.textContent = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
          return;
        }

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          errorMessageDisplay.textContent =
            "ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
          return;
        }

        if (!email.endsWith("@handong.ac.kr")) {
          errorMessageDisplay.textContent =
            "í•œë™ëŒ€í•™êµ ì´ë©”ì¼(@handong.ac.kr)ë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.";
          return;
        }

        try {
          // 2. Firebase Authenticationìœ¼ë¡œ ì‚¬ìš©ì ê³„ì • ìƒì„±
          const userCredential = await createUserWithEmailAndPassword(
            auth,
            email,
            password
          );
          const user = userCredential.user;
          console.log("Firebase Auth ê³„ì • ìƒì„± ì„±ê³µ:", user.uid);

          // 3. Firestoreì— ì¶”ê°€ ì‚¬ìš©ì ì •ë³´ ì €ì¥
          await setDoc(doc(db, "users", user.uid), {
            name: name,
            studentId: studentId,
            department: department,
            major1: major1,
            major2: major2,
            email: email,
            phone: phone,
            createdAt: new Date(),
          });

          // **íšŒì›ê°€ì… ì„±ê³µ ì‹œ alert í›„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™**
          alert("íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"); // ì•Œë¦¼ ë©”ì‹œì§€
          window.location.href = "login.html"; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        } catch (error) {
          const errorCode = error.code;
          const errorMessage = error.message;
          console.error("íšŒì›ê°€ì… ì‹¤íŒ¨:", errorCode, errorMessage);

          let displayMessage = "íšŒì›ê°€ì… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
          switch (errorCode) {
            case "auth/email-already-in-use":
              displayMessage = "ì´ë¯¸ ê°€ì…ëœ ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.";
              break;
            case "auth/invalid-email":
              displayMessage = "ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.";
              break;
            case "auth/weak-password":
              displayMessage =
                "ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤. 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
              break;
            case "auth/operation-not-allowed":
              displayMessage =
                "ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸ì´ Firebase ì½˜ì†”ì—ì„œ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.";
              break;
            case "auth/network-request-failed":
              displayMessage = "ë„¤íŠ¸ì›Œí¬ ì—°ê²° ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.";
              break;
            case "auth/api-key-not-valid":
              displayMessage =
                "Firebase ì„¤ì • ì˜¤ë¥˜: API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Firebase ì½˜ì†”ì—ì„œ êµ¬ì„± ì •ë³´ë¥¼ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.";
              break;
            default:
              displayMessage = `ì˜¤ë¥˜: ${errorMessage}`;
          }
          errorMessageDisplay.textContent = displayMessage;
        }
      }

      // ì „ì—­ ìŠ¤ì½”í”„ì— ë…¸ì¶œí•´ì•¼ í•˜ëŠ” í•¨ìˆ˜ë“¤ (onchange, onclick ë“± HTML ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ì—ì„œ í˜¸ì¶œë  í•¨ìˆ˜)
      window.toggleMajorFields = toggleMajorFields;
      window.checkPasswordMatch = checkPasswordMatch;
      window.resetForm = resetForm;
      window.saveAccount = saveAccount;

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì „ê³µ í•„ë“œ ì´ˆê¸° ìƒíƒœ ì„¤ì •
      document.addEventListener("DOMContentLoaded", toggleMajorFields);
    </script>
    <script src="script.js"></script>
    <script type="module">
      import { auth } from "./firebase-config.js";
      import {
        onAuthStateChanged,
        signOut,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

      const myAccountBtn = document.querySelector(".user-actions .btn-login");

      if (myAccountBtn) {
        onAuthStateChanged(auth, (user) => {
          if (user) {
            myAccountBtn.innerHTML =
              '<i class="fas fa-sign-out-alt"></i> ë¡œê·¸ì•„ì›ƒ';
            myAccountBtn.href = "#";
            myAccountBtn.onclick = (e) => {
              e.preventDefault();
              if (confirm("ì •ë§ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                signOut(auth).then(() => {
                  alert("ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.");
                  window.location.href = "index.html";
                });
              }
            };
          } else {
            myAccountBtn.innerHTML =
              '<i class="fas fa-user-circle"></i> My ê³„ì •';
            myAccountBtn.href = "login,membership.html";
            myAccountBtn.onclick = null;
          }
        });
      }
    </script>
  </body>
</html>
